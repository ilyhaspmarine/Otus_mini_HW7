# Event Collaboration cтиль взаимодействия с использованием брокера сообщений

## Задача
Спроектировать взаимодействие API Gateway и микросервисов при создании заказа клиентом. Использовать только aсинхронное взаимодействие через события

## Решение

### Создание заказа (только для аутентифицированных клиентов)
1. Клиент отправляет POST запрос на создание заказа на API Gateway
2. API Gateway:
   - Валидирует JWT токен
   - Проверяет, что заказ создается на имя пользователя-владельца JWT
   - Валидирует входные данные
   - Публикует сообщение OrderCreateRequested в топик orders.create
3. Сервис заказов:
   - Принимает сообщение OrderCreateRequested из топика orders.create
   - Создает новый заказ со статусом "Pending"
   - Публикует сообщение OrderPending в топик orders.pending
4. Сервис биллинга:
   - Принимает сообщение OrderPending из топика orders.pending
   - Проверяет текущий баланс кошелька пользователя
   - Если средств достаточно:
     - Создает новую операцию по кошельку пользователя на сумму заказа
     - Публикует событие PaymentProcessed c paid = true и ID созданной операции оплаты в топик billing.payments
   - Если средств недостаточно:
     - Публикует событие PaymentProcessed c paid = false в топик billing.payments
5. Сервис заказов:
   - Принимает сообщение PaymentProcessed из топика billing.payments
     - Если paid = false, переводит заказ в статус "Отменен"
     - Если paid = true, преводит заказ в статус "Оплачен" и записывает ID операции оплаты в сведения о заказе
   - Публикует сообщение OrderUpdateMessage в топик notifications.orders
6. Сервис нотификаций:
   - Принимает сообщение OrderUpdateMessage из топика notifications.orders
   - Обращается в сервис профилей за контактными данными клиента (синхронно)
   - Если заказ в статусе "Оплачен", отправляет "Письмо счастья" на почту клиента
   - Если заказ в статусе "Отменен", отправляет "Письмо горя" на почту клиента

### Sequence диаграмма
![Sequence диаграмма](img/03-sequence_all_async.png)

### Описание API
[Описание API](idl/03_all_async.md)

## Плюсы
- Низкая связность сервисов
- Падение одного сервиса не блокирует работу других
- Возможность повторной отправки "зависших" сообщений
- Статус операции не зависит от отправки уведомлений
- Гибкость масштабирования

## Минусы
- Все ещё высокое latency
- Клиент не получает прямого ответа о статусе обработки своего запроса
- Сложность сопровождения, отладки и разработки
- Выход из строя брокера остановит всю работу, а не только отправку уведомлений