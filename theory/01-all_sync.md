# Полностью синхронное взаимодействие сервисов при создании заказа

## Задача
Спроектировать взаимодействие API Gateway и микросервисов при создании заказа клиентом. Использовать только синхронное взаимодействие через HTTP.

## Решение
Сценарий взаимодействия следующий:

### Создание заказа (только для аутентифицированных клиентов)

1. Клиент отправляет POST запрос на создание заказа на API Gateway
2. API Gateway валидирует JWT токен и проверяет, что заказ создается на имя пользователя-владельца JWT. Валидирует входные данные
3. API Gateway направляет запрос на создание заказа в сервис заказов (Orders Service)
4. Сервис заказов:
   - Генерирует ID для нового заказа
   - Создает новый заказ со статусом "Pending"
   - Возвращает ID и информацию о созданном заказе
5. API Gateway принимает информацию о созданном заказе и направляет запрос на оплату в сервис биллинга (Billing Service)
6. Сервис биллинга:
   - Проверяет текущий баланс кошелька пользователя
   - Если средств достаточно:
     - Создает новую операцию по кошельку пользователя на сумму заказа
     - Возвращает реквизиты созданной операции
   - Если средств недостаточно:
     - Возвращает ошибку 406 с пояснением "Недостаточно средств"
7. API Gateway принимает информацию от сервиса биллинга и направляет запрос на обновление статуса заказа в сервис заказов (Order Service)
8. Сервис заказов:
   - Если оплата не успешна, переводит заказ в статус "Отменен"
   - Если оплата успешна, преводит заказ в статус "Оплачен"
   - Возвращает обновленные сведения о заказе
9. API Gateway принимает информацию от сервиса заказов и направляет запрос в сервис нотификаций (Notification Service)
10. Сервис нотификаций
   - Обращается в сервис профилей за контактными данными клиента
   - Если заказ в статусе "Оплачен", отправляет "Письмо счастья" на почту клиента
   - Если заказ в статусе "Отменен", отправляет "Письмо горя" на почту клиента
   - Возвращает ID созданного письма
11. API Gateway возвращает информацию о созданном заказе пользователю

### Обработка новых пользователей

1. При регистрации нового пользователя, сервис авторизации (Auth Service):
   - Создает пользователя
   - Синхронно вызывает сервис профилей для создания профиля
   - Синхронно вызывает сервис биллинга для создания счета

### Sequence диаграмма
![Sequence диаграмма](img/01-sequence_all_sync.png)   

### Описание API
[Описание API](idl/01_all_sync.md)

## Плюсы
- Проще отладка
- Проще понимание последовательности
- Клиент сразу получит информацию об успехе или провале операций

## Минусы
- Выше latency (особенно если избегать прямых взаимодействий сервисов)
- Высокая связность сервисов
- Пока не пройдет отправка уведомления, создание заказа не завершится, что нелогично
- Падение одного сервиса приведет к провалу всей транзакции