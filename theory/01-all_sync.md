# Полностью синхронное взаимодействие сервисов при создании заказа

## Задача
Спроектировать взаимодействие API Gateway и микросервисов при создании заказа клиентом. Использовать только синхронное взаимодействие через HTTP.

## Решение

### Создание заказа (только для аутентифицированных клиентов)

1. Клиент отправляет POST запрос на создание заказа на API Gateway
2. API Gateway:
   - Валидирует JWT токен
   - Проверяет, что заказ создается на имя пользователя-владельца JWT
   - Валидирует входные данные
   - Направляет запрос на создание заказа в сервис заказов (Orders Service)
3. Сервис заказов:
   - Генерирует ID для нового заказа
   - Создает новый заказ со статусом "Pending"
   - Возвращает ID и информацию о созданном заказе
4. API Gateway принимает информацию о созданном заказе и направляет запрос на оплату в сервис биллинга (Billing Service)
5. Сервис биллинга:
   - Проверяет текущий баланс кошелька пользователя
   - Если средств достаточно:
     - Создает новую операцию по кошельку пользователя на сумму заказа
     - Возвращает реквизиты созданной операции
   - Если средств недостаточно:
     - Возвращает ошибку 406 с пояснением "Недостаточно средств"
6. API Gateway принимает информацию от сервиса биллинга и направляет запрос на обновление статуса заказа в сервис заказов (Order Service)
7. Сервис заказов:
   - Если оплата не успешна, переводит заказ в статус "Отменен"
   - Если оплата успешна:
     - Переводит заказ в статус "Оплачен"
     - Записывает ID операции оплаты из сервиса биллинга в сведения о заказе
   - Возвращает обновленные сведения о заказе
8. API Gateway принимает информацию от сервиса заказов и направляет запрос в сервис нотификаций (Notification Service)
9. Сервис нотификаций
   - Обращается в сервис профилей за контактными данными клиента
   - Если заказ в статусе "Оплачен", отправляет "Письмо счастья" на почту клиента
   - Если заказ в статусе "Отменен", отправляет "Письмо горя" на почту клиента
   - Возвращает ID созданного письма
10. API Gateway возвращает информацию о созданном заказе пользователю

### Sequence диаграмма
![Sequence диаграмма](img/01-sequence_all_sync.png)   

### Описание API
[Описание API](idl/01_all_sync.md)

## Плюсы
- Проще отладка
- Проще понимание последовательности
- Клиент сразу получит информацию об успехе или провале операций

## Минусы
- Выше latency (особенно если избегать прямых взаимодействий сервисов)
- Высокая связность сервисов
- Пока не пройдет отправка уведомления, создание заказа не завершится, что нелогично
- Падение одного сервиса приведет к провалу всей транзакции